#!/bin/bash
  
##############################################################################
# run-httpd, by Steven Saus 20 Sep 2022
#
# For setting up and running the Apache webserver inside a Docker container.
#
# steven@faithcollapsing.com
# Licensed under the Apache License
##############################################################################  

set -e

##############################################################################
#
# Copy user configs into appropriate places in Docker container at spinup.
# mpd.conf
# minidlna
# snapcast
#
##############################################################################
if [ -f /media/config/mpd.conf ];then 
    cp -f /media/config/mpd.conf /etc
if
if [ -f /media/config/minidlna.conf ];then 
    cp -f /media/config/minidlna.conf /etc
if
if [ -f /media/config/snapserver.conf ];then 
    cp -f /media/config/snapserver.conf /etc
if
if [ -f /media/config/snapserver ];then 
    cp -f /media/config/snapserver /etc/default
if

# TODO

# Start avahi

# Start MPD

# Start mpdscribble

# Start snapserver

# start minidlna

##############################################################################
# For MPDQ setup
##############################################################################
# Define the two directories that MPDQ needs.
ConfigDir=${XDG_CONFIG_HOME:-$HOME/.config}/mpdq
if [ ! -d ${ConfigDir} ]; then
    mkdir -p ${ConfigDir}
fi
ConfigFile=$ConfigDir/mpdq.ini

StateDir=${XDG_STATE_HOME:-$HOME/.local/state}/mpdq
if [ ! -d ${StateDir} ]; then
    mkdir -p ${StateDir}
fi

# Copy in configurations.
if [ -f /media/config/mpdq.ini ];then 
    cp -f /media/config/mpdq.ini ${ConfigDir}
if
# The provided stub is an EXCLUSION type
if [ -f /media/config/default.cfg ];then 
    cp -f /media/config/default.cfg ${ConfigDir}
if
# Copy OUT default example with updated genre list at spinup.
if [ ! -f ${StateDir}/example_instruction_file
    mpdq -e
    cp -f ${StateDir}/example_instruction_file /media/config
fi

# Start mpdq
# TODO

##############################################################################
#
# Checking/fixing rompr permissions at spin up
#
##############################################################################
if [ ! -d /var/www/rompr/albumart ];then
    mkdir -p /var/www/rompr/{albumart,prefs}
fi
chown -R www-data:www-data /var/www/rompr/{albumart,prefs}

##############################################################################
#
# Apache site setup
#
##############################################################################

# remove all sites enabled
rm -rf /etc/apache2/sites-enabled/*
# symlink everything in sites available (which is bound to outside the container)
sites=$(ls -A "/etc/apache2/sites-available")

for site in $sites;do
    a2ensite ${site%.*}
done

if [ ! -f /etc/php/7.4/myinit ];then 
    ###############################################################################
    # Environment variables to configure php
    # Adjust as needed, then rebuild the container (docker-compose up --build)
    ###############################################################################
    sed -ri -e  's/^allow_url_fopen =.*/allow_url_fopen = On/g' /etc/php/7.4/fpm/php.ini
    sed -ri -e  's/^memory_limit =.*/memory_limit = 512M/g' /etc/php/7.4/fpm/php.ini
    sed -ri -e  's/^max_execution_time =.*/max_execution_time = 1800/g' /etc/php/7.4/fpm/php.ini
    sed -ri -e  's/^post_max_size =.*/post_max_size = 256M/g' /etc/php/7.4/fpm/php.ini
    sed -ri -e  's/^upload_max_filesize =.*/upload_max_filesize = 8M/g' /etc/php/7.4/fpm/php.ini
    sed -ri -e  's/^max_file_uploads =.*/max_file_uploads = 50/g' /etc/php/7.4/fpm/php.ini
    sed -ri -e  's/^display_errors =.*/display_errors = On/g' /etc/php/7.4/fpm/php.ini
    sed -ri -e  's/^display_startup_errors =.*/display_startup_errors = On/g' /etc/php/7.4/fpm/php.ini

    ###############################################################################
    # Load apache mods and configurations. 
    # Adjust as needed, then rebuild the container (docker-compose up --build)
    ###############################################################################
    update-rc.d php7.4-fpm defaults
    a2enmod proxy_fcgi && \
    a2enmod setenvif && \
    a2enmod alias && \
    a2enmod autoindex && \
    a2enmod deflate && \
    a2enmod dir && \
    a2enmod mime && \
    a2enmod mime_magic && \
    a2enmod rewrite && \
    a2enmod xml2enc && \
    a2enmod actions && \
    a2enmod auth_basic && \
    a2enmod cgi && \
    a2enmod expires && \
    a2enmod headers && \
    a2enmod proxy && \
    a2enmod proxy_html && \
    a2enmod proxy_http && \
    a2enmod proxy_scgi && \
    a2enmod proxy_wstunnel 

    a2enconf php7.4-fpm && \
    a2enconf charset && \
    a2enconf javascript-common && \
    a2enconf security && \
    a2enconf serve-cgi-bin 

    touch /etc/php/7.4/myinit
fi

###############################################################################
# Restart php-fpm and apache. Apache needs to be started this way so that  
# it stays in the foreground, otherwise Docker closes it down.
###############################################################################



/etc/init.d/php7.4-fpm restart
apachectl -D FOREGROUND
